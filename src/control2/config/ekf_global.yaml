ekf_filter_node_map:
  ros__parameters:
    # Main filter frequency - runs prediction at 50Hz regardless of sensor rates
    frequency: 50.0
    
    # CRITICAL: Increased timeout for 1Hz GPS (2x the GPS period for safety)
    sensor_timeout: 2.0
    
    # Enable 2D mode for ground-based rover
    two_d_mode: true
    
    # This filter publishes map->odom transform
    publish_tf: true
    
    # Frame configuration - world_frame MUST be 'map' for GPS integration
    map_frame: map
    odom_frame: odom
    base_link_frame: base_link
    world_frame: map
    
    # Transform timeout
    transform_time_offset: 0.0
    transform_timeout: 0.0
    
    # Print diagnostics
    print_diagnostics: true
    debug: false
    debug_out_file: /tmp/ekf_global_debug.txt
    
    # Permit corrected publication of transforms
    permit_corrected_publication: false
    
    # Smooth Lagged Data - helps with GPS delays
    smooth_lagged_data: true
    history_length: 3.0
    
    # ============================================================================
    # SENSOR INPUTS
    # ============================================================================
    
    # ---------- ODOM0: ZED2i Visual Odometry ----------
    odom0: /zed2i/odom
    odom0_config: [true,  true,  false,   # x, y position (z disabled in 2D)
                   false, false, true,    # roll, pitch disabled; yaw enabled
                   true,  true,  false,   # x_dot, y_dot velocities; z_dot disabled
                   false, false, true,    # roll_dot, pitch_dot disabled; yaw_dot enabled
                   false, false, false]   # accelerations not used from odometry
    odom0_differential: false
    odom0_relative: false
    odom0_queue_size: 10
    
    # Reject outliers that deviate more than 5 meters/radians
    odom0_pose_rejection_threshold: 5.0
    odom0_twist_rejection_threshold: 1.0
    
    
    # ---------- IMU0: ZED2i IMU ----------
    # NOTE: yaw is DISABLED to prevent conflict with GPS-derived heading
    imu0: /zed2i/imu/data
    imu0_config: [false, false, false,   # position (IMUs don't provide position)
                  true,  true,  false,   # roll, pitch enabled; yaw DISABLED for GPS
                  false, false, false,   # velocities not used
                  true,  true,  true,    # angular velocities (roll_dot, pitch_dot, yaw_dot)
                  true,  true,  false]   # linear accelerations (x_ddot, y_ddot; z disabled in 2D)
    imu0_differential: false
    imu0_relative: false
    imu0_queue_size: 10
    imu0_remove_gravitational_acceleration: true
    
    # Rejection thresholds for IMU outliers
    imu0_angular_velocity_rejection_threshold: 2.0
    imu0_linear_acceleration_rejection_threshold: 3.0
    
    
    # ---------- IMU1: MPU6050 External IMU ----------
    imu1: /imu/data_external
    imu1_config: [false, false, false,   # position
                  true,  true,  false,   # roll, pitch enabled; yaw DISABLED
                  false, false, false,   # velocities
                  true,  true,  true,    # angular velocities
                  true,  true,  false]   # linear accelerations
    imu1_differential: false
    imu1_relative: false
    imu1_queue_size: 10
    imu1_remove_gravitational_acceleration: true
    
    imu1_angular_velocity_rejection_threshold: 2.0
    imu1_linear_acceleration_rejection_threshold: 3.0
    
    
    # ---------- ODOM1: GPS-derived Odometry from navsat_transform ----------
    # This is your 1Hz GPS data converted to odometry
    odom1: /odometry/gps
    odom1_config: [true,  true,  false,   # x, y position from GPS (CRITICAL)
                   false, false, false,   # GPS doesn't provide orientation
                   false, false, false,   # GPS velocities not used (noisy at 1Hz)
                   false, false, false,   # angular velocities not from GPS
                   false, false, false]   # accelerations not from GPS
    odom1_differential: false  # GPS provides absolute position, not relative
    odom1_relative: false
    odom1_queue_size: 10
    
    # Be lenient with GPS outlier rejection (GPS can jump)
    odom1_pose_rejection_threshold: 10.0
    
    
    # ============================================================================
    # COVARIANCE MATRICES
    # ============================================================================
    
    # Initial estimate covariance - affects convergence speed
    # Rule: Make diagonal values LARGER than sensor covariances for measured variables
    # Position states should start with high uncertainty when using GPS
    initial_estimate_covariance: [1.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  1.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  1e6,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.1,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.1,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.1,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.5,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.5,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e6,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.1,  0.0,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.1,  0.0,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.1,  0.0,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.1,  0.0,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.1,  0.0,
                                  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  1e6]
    
    # Process noise covariance - models state evolution uncertainty
    # Increased slightly for position states to allow GPS corrections at 1Hz
    # Order: x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az
    process_noise_covariance: [0.05, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.05, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.06, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.03, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.03, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.06, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.025,0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.025,0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.04, 0.0,  0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.01, 0.0,  0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.01, 0.0,  0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.02, 0.0,  0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.015,0.0,  0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.015,0.0,
                               0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.015]
